---
typora-root-url: image
---

[TOC]



## 2.7：统计各省市的地域分布情况

### 2.7.1：APP类添加逻辑：

```scala
//TODO 统计各省市的地域分布情况
ProviceCityAnalysis.process(spark,context)
```

### 2.7.2：开发ProviceCityAnalysis

```scala
package pro

import `trait`.Process
import org.apache.kudu.client.CreateTableOptions
import org.apache.kudu.spark.kudu.KuduContext
import org.apache.spark.sql.SparkSession
import utils.{ConfigUtils, DateUtils, KuduUtils}

/**
  * 统计各省市的地域分布情况
  */
object ProviceCityAnalysis extends Process{
  /**
    * 逻辑处理部分，后期不同的操作写不同的逻辑
    */
  //指明数据读取表
  val SOURCE_TABLE = s"ODS_${DateUtils.getNow()}"
  //指明kudu的信息
  val options = Map[String,String](
    "kudu.master"->ConfigUtils.KUDU_MASTER,
    "kudu.table"->SOURCE_TABLE
  )
  //指明指标数据保存表
  val SINK_TABLE = s"provice_city_${DateUtils.getNow()}"
  override def process(spark: SparkSession, kuduContext: KuduContext): Unit = {
    //1、从ODS表获取
    import org.apache.kudu.spark.kudu._
    spark.read.options(options).kudu.createOrReplaceTempView("t_data_info")
    //2、报表统计
    val result = spark.sql(
      """
        |select proviceName,city,count(1)
        | from t_data_info
        | group by proviceName,city
      """.stripMargin)
    //3、写入kudu
    //定义schema信息
    val schema = result.schema

    //定义表的属性
    val option = new CreateTableOptions()

    //设置分区策略 分区字段 分区数
    val columns = Seq[String]("proviceName","city")
    import scala.collection.JavaConverters._
    option.addHashPartitions(columns.asJava,3)
    //设置副本数
    option.setNumReplicas(3)

    //指定主键
    val keys = columns
    KuduUtils.writeToKudu(kuduContext,schema,option,SINK_TABLE,result,keys)
  }
}
```

### 2.7.3：执行APP并查看结果

#### 2.7.3.1：查看kudu页面，是否生成kudu表

![image-20181030113009830](image-20181030113009830.png)

#### 2.7.3.2：将kudu数据作为impala外部表，并查看数据是否写入kudu

```SQL
[angel1:21000] > CREATE EXTERNAL TABLE `PRO_CITY` STORED AS KUDU
               > TBLPROPERTIES(
               >     'kudu.table_name' = 'PRO_CITY',
               >     'kudu.master_addresses' = 'hadoop01:7051,hadoop02:7051,hadoop03:7051');
Query: create EXTERNAL TABLE `PRO_CITY` STORED AS KUDU
TBLPROPERTIES(
    'kudu.table_name' = 'PRO_CITY',
    'kudu.master_addresses' = 'hadoop01:7051,hadoop02:7051,hadoop03:7051')
Fetched 0 row(s) in 0.25s
```

```SQL
[angel1:21000] > select * from pro_city limit 3;
Query: select * from pro_city limit 3
Query submitted at: 2018-10-30 11:32:09 (Coordinator: http://angel1:25000)
Query progress can be monitored at: http://angel1:25000/query_plan?query_id=2a471363368f246d:ffc4a46700000000
+--------------+--------------+-----+
| provincename | cityname     | num |
+--------------+--------------+-----+
| 上海市南汇区 | 上海市南汇区 | 2   |
| 上海市黄浦区 | 上海市黄浦区 | 2   |
| 中国         | 中国         | 29  |
+--------------+--------------+-----+
Fetched 3 row(s) in 0.17s
```



## 2.8：广告投放的地域分布情况统计

### 2.8.1：查询地域分布情况表格

按照产品需求，我们需要完成如下模式的报表

| 省/市    | 原始请求数 | 有效请求数 | 广告请求数 | 参与竞价数 | 竞价成功数 | 竞价成功率 | 展示量 | 点击量 | 点击率 | 广告成本 | 广告消费 |
| -------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- | ------ | ------ | ------ | -------- | -------- |
| 河北省   |            |            |            | 1000       | 10         |            |        |        |        |          |          |
| 唐山市   |            |            |            |            |            |            |        |        |        |          |          |
| 石家庄市 |            |            |            |            |            |            |        |        |        |          |          |
|          |            |            |            |            |            |            |        |        |        |          |          |
|          |            |            |            |            |            |            |        |        |        |          |          |

### 2.8.2：查询地域分布情况的指标逻辑

完成【2.8.1】中的报表，需要如下的指标逻辑

| 指标                    | 说明                                           | adplatformproviderid | requestmode | processnode | iseffective | isbilling | isbid | iswin | adorderid | adcreativeid |
| ----------------------- | ---------------------------------------------- | -------------------- | ----------- | ----------- | ----------- | --------- | ----- | ----- | --------- | ------------ |
| 原始请求                | 发来的所有原始请求数                           |                      | 1           | >=1         |             |           |       |       |           |              |
| 有效请求                | 满足有效体检的数量                             |                      | 1           | >=2         |             |           |       |       |           |              |
| 广告请求                | 满足广告请求的请求数量                         |                      | 1           | 3           |             |           |       |       |           |              |
| 参与竞价数              | 参与竞价的次数                                 | >=100000             |             |             | 1           | 1         | 1     |       | !=0       |              |
| 竞价成功数              | 成功竞价的次数                                 | >=100000             |             |             | 1           | 1         |       | 1     |           |              |
| （广告主）展示数        | 针对广告主统计：广告最终在终端被展示的数量     |                      | 2           |             | 1           |           |       |       |           |              |
| （广告主）点击数        | 针对广告主统计：广告被展示后，实际被点击的数量 |                      | 3           |             | 1           |           |       |       |           |              |
| （媒介）展示数          | 针对媒介统计：广告在终端被展示的数量           |                      | 2           |             | 1           | 1         |       |       |           |              |
| （媒介）点击数          | 针对媒介统计：展示的广告实际被点击的数量       |                      | 3           |             | 1           | 1         |       |       |           |              |
| DSP广告消费             | winprice/1000                                  | >=100000             |             |             | 1           | 1         |       | 1     | >200000   | >200000      |
| DSP广告成本(每千人成本) | adpayment/1000                                 | >=100000             |             |             | 1           | 1         |       | 1     | >200000   | >200000      |

**DSP广告消费 是广告主的消费**

**DSP广告成本 是DSP平台的消费**

**赚钱 = DSP广告成本 - DSP广告消费**

### 2.8.3：APP类添加逻辑

```scala
    //TODO 统计广告投放的地域分布情况
    AdRegionAnalysis.process(spark,context)
```

### 2.8.4：开发：AdRegionAnalysis

```scala
package pro

import `trait`.Process
import org.apache.kudu.client.CreateTableOptions
import org.apache.kudu.spark.kudu.KuduContext
import org.apache.spark.sql.SparkSession
import utils.{ConfigUtils, DateUtils, KuduUtils}

/**
  * 统计广告投放的地域分布情况
  */
object AdRegionAnalysis extends Process{

  //定义数据原表
  val SOURCE_TABLE = s"ODS_20190815"
  //定义kudu信息
  val options = Map[String,String](
    "kudu.master"->ConfigUtils.KUDU_MASTER,
    "kudu.table"->SOURCE_TABLE
  )
  //指定数据存入表名
  val SINK_TABLE = s"ad_region_analysis_${DateUtils.getNow()}"
  /**
    * 逻辑处理部分，后期不同的操作写不同的逻辑
    */
  override def process(spark: SparkSession, kuduContext: KuduContext): Unit = {
    //1、读取ODS表的数据
    import org.apache.kudu.spark.kudu._
    spark.read.options(options).kudu.createOrReplaceTempView("t_data_info")
    //2、统计报表
        //1、统计原始请求、有效请求、广告请求、展示量、点击量、参与竞价数、竞价成功数、广告成本、广告消费
    spark.sql(
      """
        |select
        | region,city,
        | sum(case when requestmode=1 and processnode>=1 then 1 else 0 end) org_num,
        | sum(case when requestmode=1 and processnode>=2 then 1 else 0 end) valid_num,
        | sum(case when requestmode=1 and processnode=3 then 1 else 0 end) ad_num,
        | sum(case when adplatformproviderid>=100000 and iseffective=1 and isbilling=1 and isbid=1 and adorderid!=0 then 1 else 0 end) bid_num,
        | sum(case when iseffective=1 and iswin=1 and isbilling=1 and adplatformproviderid>=100000 then 1 else 0 end) bid_success_num,
        | sum(case when requestmode=2 and iseffective=1 then 1 else 0 end) show_num,
        | sum(case when requestmode=3 and iseffective=1 then 1 else 0 end) click_num,
        | sum(case when requestmode=2 and iseffective=1 and isbilling=1 then 1 else 0 end) media_show_num,
        | sum(case when requestmode=3 and iseffective=1 and isbilling=1 then 1 else 0 end) media_click_num,
        | sum(case when adplatformproviderid>=100000 and iseffective=1 and isbilling=1 and iswin=1 and adorderid>200000 and adcreativeid>200000 then winprice/1000 else 0 end) consumtion_number,
        | sum(case when adplatformproviderid>=100000 and iseffective=1 and isbilling=1 and iswin=1 and adorderid>200000 and adcreativeid>200000 then adpayment/1000 else 0 end) cost_number
        |from t_data_info
        |group by region,city
      """.stripMargin).createOrReplaceTempView("t_tmp_info")
        //2、计算竞价成功率、点击率
      val result = spark.sql(
        """
          |select
          | region,city,
          | org_num,
          | valid_num,
          | ad_num,
          | bid_num,
          | bid_success_num,
          | bid_success_num/bid_num bid_success_rat,
          | show_num,
          | click_num,
          | click_num/show_num click_rat,
          | media_show_num,
          | media_click_num,
          | consumtion_number,
          | cost_number
          | from t_tmp_info
        """.stripMargin)
    //3、写入KDUDU
    //指定表的schema
    val schema = result.schema
    val kuduOptions = new CreateTableOptions()
    //设置表的分区策略 分区字段 分区数
    val columns = Seq[String]("region","city")
    import scala.collection.JavaConverters._
    kuduOptions.addHashPartitions(columns.asJava,3)

    //设置副本数
    kuduOptions.setNumReplicas(3)
    //设置主键字段
    val keys = columns
    KuduUtils.writeToKudu(kuduContext,schema,kuduOptions,SINK_TABLE,result,keys)
  }
}

```

### 2.8.5：执行APP并查询结果

#### 2.8.5.1：查看kudu页面，是否生成kudu表

![image-20181030140951864](image-20181030140951864.png)



#### 2.8.5.2：将kudu数据作为impala外部表，并查看数据是否写入kudu

```sql
CREATE EXTERNAL TABLE `RegionalAnalysis` STORED AS KUDU
TBLPROPERTIES(
    'kudu.table_name' = 'RegionalAnalysis',
    'kudu.master_addresses' = 'hadoop01:7051,hadoop02:7051,hadoop03:7051')
```

```sql
[angel1:21000] > select * from RegionalAnalysis limit 4;
Query: select * from RegionalAnalysis limit 4
Query submitted at: 2018-10-30 16:43:50 (Coordinator: http://angel1:25000)
Query progress can be monitored at: http://angel1:25000/query_plan?query_id=848fc430aae1528:af00b1ef00000000
+--------------+--------------+-----------------+--------------+-----------+---------+---------+------------+---------------+----------+------------+--------+---------------+
| provincename | cityname     | originalrequest | validrequest | adrequest | bidsnum | bidssus | bidssusrat | adimpressions | adclicks | adclickrat | adcost | adconsumption |
+--------------+--------------+-----------------+--------------+-----------+---------+---------+------------+---------------+----------+------------+--------+---------------+
| 新疆塔城地区 | 新疆塔城地区 | 0               | 0            | 0         | 0       | 0       | NULL       | 1             | 0        | 0          | 0      | 0             |
| 新疆昌吉州   | 新疆昌吉州   | 0               | 0            | 0         | 1       | 0       | 0          | 1             | 0        | 0          | 0      | 0             |
| 湖北省       | 武汉市青山区 | 0               | 0            | 0         | 0       | 0       | NULL       | 1             | 0        | 0          | 0      | 0             |
| 甘肃省       | 甘肃省       | 0               | 0            | 0         | 0       | 0       | NULL       | 1             | 0        | 0          | 0      | 0             |
+--------------+--------------+-----------------+--------------+-----------+---------+---------+------------+---------------+----------+------------+--------+---------------+
Fetched 4 row(s) in 4.68s
```

## 2.9：广告投放的APP分布情况统计

### 2.9.1：广告投放的APP分布情况表格

按照产品需求，我们需要完成如下模式的报表

| APP_ID     | APP_NAME | 原始请求 | 有效请求 | 广告请求 | 参与竞价数 | 竞价成功数 | 竞价成功率 | 展示量 | 点击量 | 点击率 | 广告消费 | 广告成本 |
| ---------- | -------- | -------- | -------- | -------- | ---------- | ---------- | ---------- | ------ | ------ | ------ | -------- | -------- |
| XRX1000073 | YY直播   |          |          |          | 1000       | 10         |            |        |        |        |          |          |
| XRX1000071 | 今日头条 |          |          |          |            |            |            |        |        |        |          |          |
| XRX1000023 | 抖音     |          |          |          |            |            |            |        |        |        |          |          |
|            |          |          |          |          |            |            |            |        |        |        |          |          |
|            |          |          |          |          |            |            |            |        |        |        |          |          |

### 2.9.2：查询APP投放情况的指标逻辑

| 指标                    | 说明                                           | adplatformproviderid | requestmode | processnode | iseffective | isbilling | isbid | iswin | adorderid | adcreativeid |
| ----------------------- | ---------------------------------------------- | -------------------- | ----------- | ----------- | ----------- | --------- | ----- | ----- | --------- | ------------ |
| 原始请求                | 发来的所有原始请求数                           |                      | 1           | >=1         |             |           |       |       |           |              |
| 有效请求                | 满足有效体检的数量                             |                      | 1           | >=2         |             |           |       |       |           |              |
| 广告请求                | 满足广告请求的请求数量                         |                      | 1           | 3           |             |           |       |       |           |              |
| 参与竞价数              | 参与竞价的次数                                 | >=100000             |             |             | 1           | 1         | 1     |       | !=0       |              |
| 竞价成功数              | 成功竞价的次数                                 | >=100000             |             |             | 1           | 1         |       | 1     |           |              |
| （广告主）展示数        | 针对广告主统计：广告最终在终端被展示的数量     |                      | 2           |             | 1           |           |       |       |           |              |
| （广告主）点击数        | 针对广告主统计：广告被展示后，实际被点击的数量 |                      | 3           |             | 1           |           |       |       |           |              |
| （媒介）展示数          | 针对媒介统计：广告在终端被展示的数量           |                      | 2           |             | 1           | 1         |       |       |           |              |
| （媒介）点击数          | 针对媒介统计：展示的广告实际被点击的数量       |                      | 3           |             | 1           | 1         |       |       |           |              |
| DSP广告消费             | winprice/1000                                  | >=100000             |             |             | 1           | 1         |       | 1     | >200000   | >200000      |
| DSP广告成本(每千人成本) | adpayment/1000                                 | >=100000             |             |             | 1           | 1         |       | 1     | >200000   | >200000      |

### 2.9.3：APP类添加逻辑

```scala
//TODO 统计广告投放的APP分布情况
AppAnaylysis.process(spark,context)
```

### 2.9.5：开发AppAnaylysis

```scala
package pro

import `trait`.Process
import org.apache.kudu.client.CreateTableOptions
import org.apache.kudu.spark.kudu.KuduContext
import org.apache.spark.sql.SparkSession
import utils.{ConfigUtils, DateUtils, KuduUtils}

/**
  * 统计广告投放的app分布情况
  */
object AppAnaylysis extends Process{

  //定义数据存入表
  val SINK_TABLE = s"ad_app_analysis_${DateUtils.getNow()}"
  //定义数据原表
  val SOURCE_TABLE = s"ODS_${DateUtils.getNow()}"
  //定义kudu信息
  val options = Map[String,String](
    "kudu.master"->ConfigUtils.KUDU_MASTER,
    "kudu.table"->SOURCE_TABLE
  )
  /**
    * 逻辑处理部分，后期不同的操作写不同的逻辑
    */
  override def process(spark: SparkSession, kuduContext: KuduContext): Unit = {

    //1、读取ODS表的数据
    import org.apache.kudu.spark.kudu._
    spark.read.options(options).kudu.createOrReplaceTempView("t_data_info")
    //2、统计报表
      //1、统计原始请求数、有效请求数、广告请求数、展示量、点击量、参与竞价数、竞价成功数、广告成本、广告消费
    spark.sql(
      """
        |select
        | appid,appname,
        | sum(case when requestmode=1 and processnode>=1 then 1 else 0 end) org_num,
        | sum(case when requestmode=1 and processnode>=2 then 1 else 0 end) valid_num,
        | sum(case when requestmode=1 and processnode=3 then 1 else 0 end) ad_num,
        | sum(case when adplatformproviderid>=100000 and iseffective=1 and isbilling=1 and isbid=1 and adorderid!=0 then 1 else 0 end) bid_num,
        | sum(case when iseffective=1 and iswin=1 and isbilling=1 and adplatformproviderid>=100000 then 1 else 0 end) bid_success_num,
        | sum(case when requestmode=2 and iseffective=1 then 1 else 0 end) show_num,
        | sum(case when requestmode=3 and iseffective=1 then 1 else 0 end) click_num,
        | sum(case when requestmode=2 and iseffective=1 and isbilling=1 then 1 else 0 end) media_show_num,
        | sum(case when requestmode=3 and iseffective=1 and isbilling=1 then 1 else 0 end) media_click_num,
        | sum(case when adplatformproviderid>=100000 and iseffective=1 and isbilling=1 and iswin=1 and adorderid>200000 and adcreativeid>200000 then winprice/1000 else 0 end) consumtion_number,
        | sum(case when adplatformproviderid>=100000 and iseffective=1 and isbilling=1 and iswin=1 and adorderid>200000 and adcreativeid>200000 then adpayment/1000 else 0 end) cost_number
        |from t_data_info
        |group by appid,appname
      """.stripMargin).createOrReplaceTempView("t_tmp_info")
    //2、计算竞价成功率、点击率
    val result = spark.sql(
      """
        |select
        | appid,appname,
        | org_num,
        | valid_num,
        | ad_num,
        | bid_num,
        | bid_success_num,
        | bid_success_num/bid_num bid_success_rat,
        | show_num,
        | click_num,
        | click_num/show_num click_rat,
        | media_show_num,
        | media_click_num,
        | consumtion_number,
        | cost_number
        | from t_tmp_info
      """.stripMargin)

    //3、写入kudu
    val schema = result.schema
    val kuduOptions = new CreateTableOptions()
    //设置分区字段 分区策略 分区数
    val columns = Seq[String]("appid","appname")
    import scala.collection.JavaConverters._
    kuduOptions.addHashPartitions(columns.asJava,3)
    //设置副本数
    kuduOptions.setNumReplicas(3)
    //设置主键
    val keys = columns
    KuduUtils.writeToKudu(kuduContext,schema,kuduOptions,SINK_TABLE,result,keys)
  }
}
```

### 2.9.6：执行APP并查询结果

#### 2.9.6.1：查看kudu页面，是否生成kudu表

![image-20181030165603793](image-20181030165603793.png)

#### 2.9.6.2：将kudu数据作为impala外部表，并查看数据是否写入kudu

```sql
CREATE EXTERNAL TABLE `AppStuation` STORED AS KUDU
TBLPROPERTIES(
    'kudu.table_name' = 'AppStuation',
    'kudu.master_addresses' = 'hadoop01:7051,hadoop02:7051,hadoop03:7051')
```



```
[angel1:21000] > select * from appstuation limit 4;
Query: select * from appstuation limit 4
Query submitted at: 2018-10-30 16:48:33 (Coordinator: http://angel1:25000)
Query progress can be monitored at: http://angel1:25000/query_plan?query_id=904aadef65862244:937308bf00000000
+------------+---------+-----------------+--------------+-----------+---------+---------+--------------------+------------------+----------------+----------+
| appid      | appname | originalrequest | validrequest | adrequest | bidsnum | bidssus | bidssusrat         | mediumdisplaynum | mediumclicknum | clickrat |
+------------+---------+-----------------+--------------+-----------+---------+---------+--------------------+------------------+----------------+----------+
| XRX1000073 | 滴滴    | 1               | 1            | 1         | 2       | 2       | 1                  | 5                | 5              | 1        |
| XRX1000051 | 斗鱼    | 2               | 0            | 0         | 2       | 1       | 0.5                | 5                | 2              | 0.4      |
| XRX1000055 | NICE    | 4               | 3            | 2         | 3       | 1       | 0.3333333333333333 | 3                | 3              | 1        |
| XRX1000067 | 58同城  | 3               | 2            | 1         | 3       | 3       | 1                  | 5                | 5              | 1        |
+------------+---------+-----------------+--------------+-----------+---------+---------+--------------------+------------------+----------------+----------+
Fetched 4 row(s) in 0.23s
```





## 2.10：广告投放的手机设备类型分布情况统计

### 2.10.1：广告投放的手机设备分布情况表格

1 IOS

2 android

3 wp

4 other

| 手机设备类型 | 手机设备型号 | 有效请求 | 广告请求 | 参与竞价数 | 竞价成功数 | 竞价成功率 | 展示量 | 点击量 | 点击率 | 广告成本 | 广告消费 |
| ------------ | ------------ | -------- | -------- | ---------- | ---------- | ---------- | ------ | ------ | ------ | -------- | -------- |
| ios          | iphone6s     |          |          |            |            |            |        |        |        |          |          |
|              |              |          |          |            |            |            |        |        |        |          |          |
|              |              |          |          |            |            |            |        |        |        |          |          |

### 2.10.2：查询手机分布情况的指标逻辑

| 指标                    | 说明                                           | adplatformproviderid | requestmode | processnode | iseffective | isbilling | isbid | iswin | adorderid | adcreativeid |
| ----------------------- | ---------------------------------------------- | -------------------- | ----------- | ----------- | ----------- | --------- | ----- | ----- | --------- | ------------ |
| 原始请求                | 发来的所有原始请求数                           |                      | 1           | >=1         |             |           |       |       |           |              |
| 有效请求                | 满足有效体检的数量                             |                      | 1           | >=2         |             |           |       |       |           |              |
| 广告请求                | 满足广告请求的请求数量                         |                      | 1           | 3           |             |           |       |       |           |              |
| 参与竞价数              | 参与竞价的次数                                 | >=100000             |             |             | 1           | 1         | 1     |       | !=0       |              |
| 竞价成功数              | 成功竞价的次数                                 | >=100000             |             |             | 1           | 1         |       | 1     |           |              |
| （广告主）展示数        | 针对广告主统计：广告最终在终端被展示的数量     |                      | 2           |             | 1           |           |       |       |           |              |
| （广告主）点击数        | 针对广告主统计：广告被展示后，实际被点击的数量 |                      | 3           |             | 1           |           |       |       |           |              |
| （媒介）展示数          | 针对媒介统计：广告在终端被展示的数量           |                      | 2           |             | 1           | 1         |       |       |           |              |
| （媒介）点击数          | 针对媒介统计：展示的广告实际被点击的数量       |                      | 3           |             | 1           | 1         |       |       |           |              |
| DSP广告消费             | winprice/1000                                  | >=100000             |             |             | 1           | 1         |       | 1     | >200000   | >200000      |
| DSP广告成本(每千人成本) | adpayment/1000                                 | >=100000             |             |             | 1           | 1         |       | 1     | >200000   | >200000      |

### 2.10.3：APP类添加逻辑

```scala
    //TODO 统计广告投放设备类型分布情况
    AdDeviceTypeAnalysis.process(spark,context)
```

### 2.10.4：开发AdDeviceTypeAnalysis

```scala
package pro

import `trait`.Process
import org.apache.kudu.client.CreateTableOptions
import org.apache.kudu.spark.kudu.KuduContext
import org.apache.spark.sql.SparkSession
import utils.{ConfigUtils, DateUtils, KuduUtils}

/**
  * 统计广告投放的设备类型分布情况
  */
object AdDeviceTypeAnalysis extends Process{
  //定义原表
  val SOURCE_TABLE = s"ODS_${DateUtils.getNow()}"

  //定义kudu信息
  val options = Map[String,String](
    "kudu.master"->ConfigUtils.KUDU_MASTER,
    "kudu.table"->SOURCE_TABLE
  )

  //定义数据存入表名
  val SINK_TABLE = s"ad_device_type_analysis_${DateUtils.getNow()}"
  /**
    * 逻辑处理部分，后期不同的操作写不同的逻辑
    */
  override def process(spark: SparkSession, kuduContext: KuduContext): Unit = {
    //1、读取ODS
    import org.apache.kudu.spark.kudu._
    spark.read.options(options).kudu.createOrReplaceTempView("t_data_info")
    //2、报表统计

    //1、统计原始请求数、有效请求数、广告请求数、展示量、点击量、参与竞价数、竞价成功数、广告成本、广告消费
    spark.sql(
      """
        |select
        | case when client=1 then 'android '
        |       when  client=2  then 'ios'
        |       when client=3 then 'wp'
        |       else 'other'
        |       end as client,device,
        | sum(case when requestmode=1 and processnode>=1 then 1 else 0 end) org_num,
        | sum(case when requestmode=1 and processnode>=2 then 1 else 0 end) valid_num,
        | sum(case when requestmode=1 and processnode=3 then 1 else 0 end) ad_num,
        | sum(case when adplatformproviderid>=100000 and iseffective=1 and isbilling=1 and isbid=1 and adorderid!=0 then 1 else 0 end) bid_num,
        | sum(case when iseffective=1 and iswin=1 and isbilling=1 and adplatformproviderid>=100000 then 1 else 0 end) bid_success_num,
        | sum(case when requestmode=2 and iseffective=1 then 1 else 0 end) show_num,
        | sum(case when requestmode=3 and iseffective=1 then 1 else 0 end) click_num,
        | sum(case when requestmode=2 and iseffective=1 and isbilling=1 then 1 else 0 end) media_show_num,
        | sum(case when requestmode=3 and iseffective=1 and isbilling=1 then 1 else 0 end) media_click_num,
        | sum(case when adplatformproviderid>=100000 and iseffective=1 and isbilling=1 and iswin=1 and adorderid>200000 and adcreativeid>200000 then winprice/1000 else 0 end) consumtion_number,
        | sum(case when adplatformproviderid>=100000 and iseffective=1 and isbilling=1 and iswin=1 and adorderid>200000 and adcreativeid>200000 then adpayment/1000 else 0 end) cost_number
        |from t_data_info
        |group by client,device
      """.stripMargin).createOrReplaceTempView("t_tmp_info")
    //2、计算竞价成功率、点击率
    val result = spark.sql(
      """
        |select
        | client,device,
        | org_num,
        | valid_num,
        | ad_num,
        | bid_num,
        | bid_success_num,
        | bid_success_num/bid_num bid_success_rat,
        | show_num,
        | click_num,
        | click_num/show_num click_rat,
        | media_show_num,
        | media_click_num,
        | consumtion_number,
        | cost_number
        | from t_tmp_info
      """.stripMargin)
    //3、数据写入
    val schema = result.schema

    //定义表属性 分区策略 分区数 分区字段
    val kuduOptions = new CreateTableOptions()

    //分区字段
    val columns = Seq[String]("client","device")
    import scala.collection.JavaConverters._
    kuduOptions.addHashPartitions(columns.asJava,3)

    //设置副本数
    kuduOptions.setNumReplicas(3)
    //设置主键
    val keys = columns
    KuduUtils.writeToKudu(kuduContext,schema,kuduOptions,SINK_TABLE,result,keys)
  }
}
```

### 2.10.5：执行APP并查询结果

#### 2.10.5.1：查看kudu页面，是否生成kudu表

![image-20181030181317915](image-20181030181317915.png)

#### 2.10.5.2：将kudu数据作为impala外部表，并查询数据是否进入kudu

```sql
CREATE EXTERNAL TABLE `DeviceStuation` STORED AS KUDU
TBLPROPERTIES(
    'kudu.table_name' = 'DeviceStuation',
    'kudu.master_addresses' = 'hadoop01:7051,hadoop02:7051,hadoop03:7051')
```

```
[angel1:21000] > select * from devicestuation limit 20;
Query: select * from devicestuation limit 20
Query submitted at: 2018-10-30 18:07:14 (Coordinator: http://angel1:25000)
Query progress can be monitored at: http://angel1:25000/query_plan?query_id=1e423211893ab9a8:96b2c8f100000000
+---------+----------------+-----------------+--------------+-----------+---------+---------+------------+------------------+----------------+--------------------+
| client  | device         | originalrequest | validrequest | adrequest | bidsnum | bidssus | bidssusrat | mediumdisplaynum | mediumclicknum | clickrat           |
+---------+----------------+-----------------+--------------+-----------+---------+---------+------------+------------------+----------------+--------------------+
| ios     | HUAWEI GX1手机 | 9               | 7            | 3         | 4       | 1       | 0.25       | 6                | 6              | 1                  |
| ios     | NOTE8          | 9               | 8            | 5         | 5       | 4       | 0.8        | 7                | 5              | 0.7142857142857143 |
| android | IPHONE6S       | 9               | 6            | 4         | 5       | 3       | 0.6        | 9                | 8              | 0.8888888888888888 |
| android | IPHONE7_PLUS   | 19              | 9            | 4         | 8       | 5       | 0.625      | 10               | 6              | 0.6                |
| wp      | Nova2          | 17              | 14           | 5         | 10      | 5       | 0.5        | 6                | 6              | 1                  |
+---------+----------------+-----------------+--------------+-----------+---------+---------+------------+------------------+----------------+--------------------+
Fetched 5 row(s) in 0.33s
```

## 2.11：广告投放的网络类型分布情况统计

### 2.11.1：广告投放的网络类型分布情表格

| 联网方式id | 联网方式名称 | 有效请求 | 广告请求 | 参与竞价数 | 竞价成功数 | 竞价成功率 | 展示量 | 点击量 | 点击率 | 广告成本 | 广告消费 |
| ---------- | ------------ | -------- | -------- | ---------- | ---------- | ---------- | ------ | ------ | ------ | -------- | -------- |
| 0          | WIFI         |          |          |            |            |            |        |        |        |          |          |
| 1          | 4G           |          |          |            |            |            |        |        |        |          |          |
|            |              |          |          |            |            |            |        |        |        |          |          |



### 2.11.2：查询网络类型情况的指标逻辑

| 指标                    | 说明                                           | adplatformproviderid | requestmode | processnode | iseffective | isbilling | isbid | iswin | adorderid | adcreativeid |
| ----------------------- | ---------------------------------------------- | -------------------- | ----------- | ----------- | ----------- | --------- | ----- | ----- | --------- | ------------ |
| 原始请求                | 发来的所有原始请求数                           |                      | 1           | >=1         |             |           |       |       |           |              |
| 有效请求                | 满足有效体检的数量                             |                      | 1           | >=2         |             |           |       |       |           |              |
| 广告请求                | 满足广告请求的请求数量                         |                      | 1           | 3           |             |           |       |       |           |              |
| 参与竞价数              | 参与竞价的次数                                 | >=100000             |             |             | 1           | 1         | 1     |       | !=0       |              |
| 竞价成功数              | 成功竞价的次数                                 | >=100000             |             |             | 1           | 1         |       | 1     |           |              |
| （广告主）展示数        | 针对广告主统计：广告最终在终端被展示的数量     |                      | 2           |             | 1           |           |       |       |           |              |
| （广告主）点击数        | 针对广告主统计：广告被展示后，实际被点击的数量 |                      | 3           |             | 1           |           |       |       |           |              |
| （媒介）展示数          | 针对媒介统计：广告在终端被展示的数量           |                      | 2           |             | 1           | 1         |       |       |           |              |
| （媒介）点击数          | 针对媒介统计：展示的广告实际被点击的数量       |                      | 3           |             | 1           | 1         |       |       |           |              |
| DSP广告消费             | winprice/1000                                  | >=100000             |             |             | 1           | 1         |       | 1     | >200000   | >200000      |
| DSP广告成本(每千人成本) | adpayment/1000                                 | >=100000             |             |             | 1           | 1         |       | 1     | >200000   | >200000      |



### 2.11.3：APP类添加逻辑

```scala
//TODO 统计广告投放的网络设备分布情况
AdNetworkAnalysis.process(spark,context)
```

### 2.11.4：开发AdNetworkAnalysis



```scala
package pro

import `trait`.Process
import org.apache.kudu.client.CreateTableOptions
import org.apache.kudu.spark.kudu.KuduContext
import org.apache.spark.sql.SparkSession
import utils.{ConfigUtils, DateUtils, KuduUtils}

/**
  * 统计广告投放的网络类型分布情况
  */
object AdNetworkAnalysis extends Process{
  //定义数据原表
  val SOURCE_TABLE = s"ODS_${DateUtils.getNow()}"

  //定义kudu的信息
  val options = Map[String,String](
    "kudu.master"->ConfigUtils.KUDU_MASTER,
    "kudu.table"->SOURCE_TABLE
  )
  //定义数据存入表
  val SINK_TABLE = s"ad_network_analysis_${DateUtils.getNow()}"
  /**
    * 逻辑处理部分，后期不同的操作写不同的逻辑
    */
  override def process(spark: SparkSession, kuduContext: KuduContext): Unit = {

    //1、读取ODS表的数据
    import org.apache.kudu.spark.kudu._
    spark.read.options(options).kudu.createOrReplaceTempView("t_data_info")
    //2、报表统计
    //1、统计原始请求数、有效请求数、广告请求数、展示量、点击量、参与竞价数、竞价成功数、广告成本、广告消费
    spark.sql(
      """
        |select
        | networkmannerid,networkmannername,
        | sum(case when requestmode=1 and processnode>=1 then 1 else 0 end) org_num,
        | sum(case when requestmode=1 and processnode>=2 then 1 else 0 end) valid_num,
        | sum(case when requestmode=1 and processnode=3 then 1 else 0 end) ad_num,
        | sum(case when adplatformproviderid>=100000 and iseffective=1 and isbilling=1 and isbid=1 and adorderid!=0 then 1 else 0 end) bid_num,
        | sum(case when iseffective=1 and iswin=1 and isbilling=1 and adplatformproviderid>=100000 then 1 else 0 end) bid_success_num,
        | sum(case when requestmode=2 and iseffective=1 then 1 else 0 end) show_num,
        | sum(case when requestmode=3 and iseffective=1 then 1 else 0 end) click_num,
        | sum(case when requestmode=2 and iseffective=1 and isbilling=1 then 1 else 0 end) media_show_num,
        | sum(case when requestmode=3 and iseffective=1 and isbilling=1 then 1 else 0 end) media_click_num,
        | sum(case when adplatformproviderid>=100000 and iseffective=1 and isbilling=1 and iswin=1 and adorderid>200000 and adcreativeid>200000 then winprice/1000 else 0 end) consumtion_number,
        | sum(case when adplatformproviderid>=100000 and iseffective=1 and isbilling=1 and iswin=1 and adorderid>200000 and adcreativeid>200000 then adpayment/1000 else 0 end) cost_number
        |from t_data_info
        |group by networkmannerid,networkmannername
      """.stripMargin).createOrReplaceTempView("t_tmp_info")
    //2、计算竞价成功率、点击率
    val result = spark.sql(
      """
        |select
        | networkmannerid,networkmannername,
        | org_num,
        | valid_num,
        | ad_num,
        | bid_num,
        | bid_success_num,
        | bid_success_num/bid_num bid_success_rat,
        | show_num,
        | click_num,
        | click_num/show_num click_rat,
        | media_show_num,
        | media_click_num,
        | consumtion_number,
        | cost_number
        | from t_tmp_info
      """.stripMargin)
    //3、结果写入kudu
    val schema = result.schema
    //定义分区策略、分区数、分区字段
    val kuduOptions = new CreateTableOptions()

    val columns = Seq[String]("networkmannerid","networkmannername")
    import scala.collection.JavaConverters._
    kuduOptions.addHashPartitions(columns.asJava,3)

    //设置副本数
    kuduOptions.setNumReplicas(3)
    //设置主键
    val keys = columns
    KuduUtils.writeToKudu(kuduContext,schema,kuduOptions,SINK_TABLE,result,keys)
  }
}

  
```



### 2.11.5：执行APP并查询结果

#### 2.11.5.1：查看kudu页面，是否生成kudu表

![image-20181030223810734](image-20181030223810734.png)

#### 2.11.5.2：将kudu数据作为impala外部表，并查询数据是否进入kudu

```sql
CREATE EXTERNAL TABLE `NetworkStuation` STORED AS KUDU
TBLPROPERTIES(
    'kudu.table_name' = 'NetworkStuation',
    'kudu.master_addresses' = 'hadoop01:7051,hadoop02:7051,hadoop03:7051')
```



```sql
[angel1:21000] > select * from NetworkStuation;
Query: select * from NetworkStuation
Query submitted at: 2018-10-30 20:54:33 (Coordinator: http://angel1:25000)
Query progress can be monitored at: http://angel1:25000/query_plan?query_id=e6437740a864face:37f58c0700000000
+-----------------+-------------------+-----------------+--------------+-----------+---------+---------+--------------------+------------------+----------------+--------------------+
| networkmannerid | networkmannername | originalrequest | validrequest | adrequest | bidsnum | bidssus | bidssusrat         | mediumdisplaynum | mediumclicknum | clickrat           |
+-----------------+-------------------+-----------------+--------------+-----------+---------+---------+--------------------+------------------+----------------+--------------------+
| 0               | WIFI              | 60              | 39           | 20        | 36      | 31      | 0.8611111111111112 | 35               | 29             | 0.8285714285714286 |
+-----------------+-------------------+-----------------+--------------+-----------+---------+---------+--------------------+------------------+----------------+--------------------+
Fetched 1 row(s) in 1.52s
```

## 2.12：广告投放的网络运营商分布情况统计

### 2.12.1：广告投放的网络运营商分布情况表格

| 运营商名称 | 有效请求 | 广告请求 | 参与竞价数 | 竞价成功数 | 竞价成功率 | 展示量 | 点击量 | 点击率 | 广告成本 | 广告消费 |
| ---------- | -------- | -------- | ---------- | ---------- | ---------- | ------ | ------ | ------ | -------- | -------- |
| 移动       |          |          |            |            |            |        |        |        |          |          |
| 电信       |          |          |            |            |            |        |        |        |          |          |
| 联通       |          |          |            |            |            |        |        |        |          |          |

### 2.12.2：查询网络运营商分布情况指标逻辑

| 指标                    | 说明                                           | adplatformproviderid | requestmode | processnode | iseffective | isbilling | isbid | iswin | adorderid | adcreativeid |
| ----------------------- | ---------------------------------------------- | -------------------- | ----------- | ----------- | ----------- | --------- | ----- | ----- | --------- | ------------ |
| 原始请求                | 发来的所有原始请求数                           |                      | 1           | >=1         |             |           |       |       |           |              |
| 有效请求                | 满足有效体检的数量                             |                      | 1           | >=2         |             |           |       |       |           |              |
| 广告请求                | 满足广告请求的请求数量                         |                      | 1           | 3           |             |           |       |       |           |              |
| 参与竞价数              | 参与竞价的次数                                 | >=100000             |             |             | 1           | 1         | 1     |       | !=0       |              |
| 竞价成功数              | 成功竞价的次数                                 | >=100000             |             |             | 1           | 1         |       | 1     |           |              |
| （广告主）展示数        | 针对广告主统计：广告最终在终端被展示的数量     |                      | 2           |             | 1           |           |       |       |           |              |
| （广告主）点击数        | 针对广告主统计：广告被展示后，实际被点击的数量 |                      | 3           |             | 1           |           |       |       |           |              |
| （媒介）展示数          | 针对媒介统计：广告在终端被展示的数量           |                      | 2           |             | 1           | 1         |       |       |           |              |
| （媒介）点击数          | 针对媒介统计：展示的广告实际被点击的数量       |                      | 3           |             | 1           | 1         |       |       |           |              |
| DSP广告消费             | winprice/1000                                  | >=100000             |             |             | 1           | 1         |       | 1     | >200000   | >200000      |
| DSP广告成本(每千人成本) | adpayment/1000                                 | >=100000             |             |             | 1           | 1         |       | 1     | >200000   | >200000      |

### 2.12.3：APP类添加逻辑



```scala
//TODO 统计广告投放运营商分布情况
AdOperatorAnalysis.process(spark,context)
```

### 2.12.4：开发AdOperatorAnalysis

```scala
package pro

import `trait`.Process
import org.apache.kudu.client.CreateTableOptions
import org.apache.kudu.spark.kudu.KuduContext
import org.apache.spark.sql.SparkSession
import utils.{ConfigUtils, DateUtils, KuduUtils}

/**
  * 统计广告投放的运营商分布情况
  */
object AdOperatorAnalysis extends Process{

  //定义数据原表
  val SOURCE_TABLE = s"ODS_${DateUtils.getNow()}"
  //定义kudu信息
  val options = Map[String,String](
    "kudu.master"->ConfigUtils.KUDU_MASTER,
    "kudu.table"->SOURCE_TABLE
  )
  //定义数据存入表
  val SINK_TABLE = s"ad_operator_analysis_${DateUtils.getNow()}"
  /**
    * 逻辑处理部分，后期不同的操作写不同的逻辑
    */
  override def process(spark: SparkSession, kuduContext: KuduContext): Unit = {
    //1、读取ODS表的数据
    import org.apache.kudu.spark.kudu._
    spark.read.options(options).kudu.createOrReplaceTempView("t_data_info")
    //2、报表统计
    //1、统计原始请求数、有效请求数、广告请求数、展示量、点击量、参与竞价数、竞价成功数、广告成本、广告消费
    spark.sql(
      """
        |select
        | ispname,
        | sum(case when requestmode=1 and processnode>=1 then 1 else 0 end) org_num,
        | sum(case when requestmode=1 and processnode>=2 then 1 else 0 end) valid_num,
        | sum(case when requestmode=1 and processnode=3 then 1 else 0 end) ad_num,
        | sum(case when adplatformproviderid>=100000 and iseffective=1 and isbilling=1 and isbid=1 and adorderid!=0 then 1 else 0 end) bid_num,
        | sum(case when iseffective=1 and iswin=1 and isbilling=1 and adplatformproviderid>=100000 then 1 else 0 end) bid_success_num,
        | sum(case when requestmode=2 and iseffective=1 then 1 else 0 end) show_num,
        | sum(case when requestmode=3 and iseffective=1 then 1 else 0 end) click_num,
        | sum(case when requestmode=2 and iseffective=1 and isbilling=1 then 1 else 0 end) media_show_num,
        | sum(case when requestmode=3 and iseffective=1 and isbilling=1 then 1 else 0 end) media_click_num,
        | sum(case when adplatformproviderid>=100000 and iseffective=1 and isbilling=1 and iswin=1 and adorderid>200000 and adcreativeid>200000 then winprice/1000 else 0 end) consumtion_number,
        | sum(case when adplatformproviderid>=100000 and iseffective=1 and isbilling=1 and iswin=1 and adorderid>200000 and adcreativeid>200000 then adpayment/1000 else 0 end) cost_number
        |from t_data_info
        |group by ispname
      """.stripMargin).createOrReplaceTempView("t_tmp_info")
    //2、计算竞价成功率、点击率
    val result = spark.sql(
      """
        |select
        | ispname,
        | org_num,
        | valid_num,
        | ad_num,
        | bid_num,
        | bid_success_num,
        | bid_success_num/bid_num bid_success_rat,
        | show_num,
        | click_num,
        | click_num/show_num click_rat,
        | media_show_num,
        | media_click_num,
        | consumtion_number,
        | cost_number
        | from t_tmp_info
      """.stripMargin)
    //3、结果写入kudu
    val schema = result.schema
    //定义分区策略 分区数 分区字段
    val kuduOptions = new CreateTableOptions()

    val columns = Seq[String]("ispname")
    import scala.collection.JavaConverters._
    kuduOptions.addHashPartitions(columns.asJava,3)
    //指定副本数
    kuduOptions.setNumReplicas(3)
    //指定主键
    val keys = columns
    KuduUtils.writeToKudu(kuduContext,schema,kuduOptions,SINK_TABLE,result,keys)
  }
} 
```

### 2.12.5：执行APP并查询结果

#### 2.12.5.1：查看kudu页面，是否生成kudu表

![image-20181031104606543](image-20181031104606543.png)

#### 2.12.5.2：将kudu数据作为impala外部表，并查询数据是否进入kudu

Impala CREATE TABLE statement

```
CREATE EXTERNAL TABLE `ISPStuation` STORED AS KUDU
TBLPROPERTIES(
    'kudu.table_name' = 'ISPStuation',
    'kudu.master_addresses' = 'hadoop01:7051,hadoop02:7051,hadoop03:7051')
```

```sql
[angel1:21000] > select * from ISPStuation limit 10;
Query: select * from ISPStuation limit 10
Query submitted at: 2018-10-31 10:30:05 (Coordinator: http://angel1:25000)
Query progress can be monitored at: http://angel1:25000/query_plan?query_id=4b442eba88d38445:e1f3800d00000000
+---------+-----------------+--------------+-----------+---------+---------+--------------------+------------------+----------------+--------------------+
| ispname | originalrequest | validrequest | adrequest | bidsnum | bidssus | bidssusrat         | mediumdisplaynum | mediumclicknum | clickrat           |
+---------+-----------------+--------------+-----------+---------+---------+--------------------+------------------+----------------+--------------------+
| 移动    | 191             | 135          | 58        | 79      | 78      | 0.9873417721518988 | 105              | 74             | 0.7047619047619048 |
| 电信    | 148             | 95           | 43        | 67      | 52      | 0.7761194029850746 | 74               | 73             | 0.9864864864864865 |
+---------+-----------------+--------------+-----------+---------+---------+--------------------+------------------+----------------+--------------------+
Fetched 2 row(s) in 5.79s
```

## 2.13：广告投放的渠道分布情况统计

### 2.13.1:广告投放的渠道分布情况表格

| 渠道ID | 有效请求 | 广告请求 | 参与竞价数 | 竞价成功数 | 竞价成功率 | 展示量 | 点击量 | 点击率 | 广告成本 | 广告消费 |
| ------ | -------- | -------- | ---------- | ---------- | ---------- | ------ | ------ | ------ | -------- | -------- |
| 23112  |          |          |            |            |            |        |        |        |          |          |
|        |          |          |            |            |            |        |        |        |          |          |
|        |          |          |            |            |            |        |        |        |          |          |

### 2.13.2：查询渠道分布情况指标逻辑

| 指标                    | 说明                                           | adplatformproviderid | requestmode | processnode | iseffective | isbilling | isbid | iswin | adorderid | adcreativeid |
| ----------------------- | ---------------------------------------------- | -------------------- | ----------- | ----------- | ----------- | --------- | ----- | ----- | --------- | ------------ |
| 原始请求                | 发来的所有原始请求数                           |                      | 1           | >=1         |             |           |       |       |           |              |
| 有效请求                | 满足有效体检的数量                             |                      | 1           | >=2         |             |           |       |       |           |              |
| 广告请求                | 满足广告请求的请求数量                         |                      | 1           | 3           |             |           |       |       |           |              |
| 参与竞价数              | 参与竞价的次数                                 | >=100000             |             |             | 1           | 1         | 1     |       | !=0       |              |
| 竞价成功数              | 成功竞价的次数                                 | >=100000             |             |             | 1           | 1         |       | 1     |           |              |
| （广告主）展示数        | 针对广告主统计：广告最终在终端被展示的数量     |                      | 2           |             | 1           |           |       |       |           |              |
| （广告主）点击数        | 针对广告主统计：广告被展示后，实际被点击的数量 |                      | 3           |             | 1           |           |       |       |           |              |
| （媒介）展示数          | 针对媒介统计：广告在终端被展示的数量           |                      | 2           |             | 1           | 1         |       |       |           |              |
| （媒介）点击数          | 针对媒介统计：展示的广告实际被点击的数量       |                      | 3           |             | 1           | 1         |       |       |           |              |
| DSP广告消费             | winprice/1000                                  | >=100000             |             |             | 1           | 1         |       | 1     | >200000   | >200000      |
| DSP广告成本(每千人成本) | adpayment/1000                                 | >=100000             |             |             | 1           | 1         |       | 1     | >200000   | >200000      |

### 2.13.3：APP类添加代码逻辑

```scala
//TODO 统计广告投放渠道分布情况
AdChannelAnalysis.process(spark,context)
```

### 2.13.4：开发AdChannelAnalysis

```scala
package pro

import `trait`.Process
import org.apache.kudu.client.CreateTableOptions
import org.apache.kudu.spark.kudu.KuduContext
import org.apache.spark.sql.SparkSession
import utils.{ConfigUtils, DateUtils, KuduUtils}

/**
  * 统计广告投放的渠道分布情况
  */
object AdChannelAnalysis extends Process{
  //定义数据原表
  val SOURCE_TABLE = s"ODS_${DateUtils.getNow()}"

  //定义kudu信息
  val options = Map[String,String](
    "kudu.master"->ConfigUtils.KUDU_MASTER,
    "kudu.table"->SOURCE_TABLE
  )

  //定义数据存入表
  val SINK_TABLE = s"ad_channel_${DateUtils.getNow()}"

  /**
    * 逻辑处理部分，后期不同的操作写不同的逻辑
    */
  override def process(spark: SparkSession, kuduContext: KuduContext): Unit = {
    //1、读取ODS表的数据
    import org.apache.kudu.spark.kudu._
    spark.read.options(options).kudu.createOrReplaceTempView("t_data_info")
    //2、报表统计
    //1、统计原始请求数、有效请求数、广告请求数、展示量、点击量、参与竞价数、竞价成功数、广告成本、广告消费
    spark.sql(
      """
        |select
        | channelid,
        | sum(case when requestmode=1 and processnode>=1 then 1 else 0 end) org_num,
        | sum(case when requestmode=1 and processnode>=2 then 1 else 0 end) valid_num,
        | sum(case when requestmode=1 and processnode=3 then 1 else 0 end) ad_num,
        | sum(case when adplatformproviderid>=100000 and iseffective=1 and isbilling=1 and isbid=1 and adorderid!=0 then 1 else 0 end) bid_num,
        | sum(case when iseffective=1 and iswin=1 and isbilling=1 and adplatformproviderid>=100000 then 1 else 0 end) bid_success_num,
        | sum(case when requestmode=2 and iseffective=1 then 1 else 0 end) show_num,
        | sum(case when requestmode=3 and iseffective=1 then 1 else 0 end) click_num,
        | sum(case when requestmode=2 and iseffective=1 and isbilling=1 then 1 else 0 end) media_show_num,
        | sum(case when requestmode=3 and iseffective=1 and isbilling=1 then 1 else 0 end) media_click_num,
        | sum(case when adplatformproviderid>=100000 and iseffective=1 and isbilling=1 and iswin=1 and adorderid>200000 and adcreativeid>200000 then winprice/1000 else 0 end) consumtion_number,
        | sum(case when adplatformproviderid>=100000 and iseffective=1 and isbilling=1 and iswin=1 and adorderid>200000 and adcreativeid>200000 then adpayment/1000 else 0 end) cost_number
        |from t_data_info
        |group by channelid
      """.stripMargin).createOrReplaceTempView("t_tmp_info")
    //2、计算竞价成功率、点击率
    val result = spark.sql(
      """
        |select
        | channelid,
        | org_num,
        | valid_num,
        | ad_num,
        | bid_num,
        | bid_success_num,
        | bid_success_num/bid_num bid_success_rat,
        | show_num,
        | click_num,
        | click_num/show_num click_rat,
        | media_show_num,
        | media_click_num,
        | consumtion_number,
        | cost_number
        | from t_tmp_info
      """.stripMargin)
    //3、结果写入
    //定义表的schema
    val schema = result.schema
    //定义表的分区策略 分区个数 分区字段
    val kuduOptions = new CreateTableOptions()

    val columns = Seq[String]("channelid")
    import scala.collection.JavaConverters._
    kuduOptions.addHashPartitions(columns.asJava,3)
    //设置副本
    kuduOptions.setNumReplicas(3)
    //定义主键
    val keys = columns
    KuduUtils.writeToKudu(kuduContext,schema,kuduOptions,SINK_TABLE,result,keys)
  }
}


```

### 2.13.5：执行APP，并查询结果

#### 2.13.5.1：查看kudu页面，是否生成kudu表

![image-20181031114211908](image-20181031114211908.png)

#### 2.13.5.2：将kudu数据作为impala外部表，并查询数据是否进入kudu

Impala CREATE TABLE statement

```
CREATE EXTERNAL TABLE `channel_stuation` STORED AS KUDU
TBLPROPERTIES(
    'kudu.table_name' = 'channel_stuation',
    'kudu.master_addresses' = 'hadoop01:7051,hadoop02:7051,hadoop03:7051')
```

```
[angel1:21000] > select * from channel_stuation limit 10;
Query: select * from channel_stuation limit 10
Query submitted at: 2018-10-31 11:25:16 (Coordinator: http://angel1:25000)
Query progress can be monitored at: http://angel1:25000/query_plan?query_id=6841cc21054aeb52:49af989600000000
+-----------+-----------------+--------------+-----------+---------+---------+--------------------+------------------+----------------+--------------------+
| channelid | originalrequest | validrequest | adrequest | bidsnum | bidssus | bidssusrat         | mediumdisplaynum | mediumclicknum | clickrat           |
+-----------+-----------------+--------------+-----------+---------+---------+--------------------+------------------+----------------+--------------------+
| 123495    | 5               | 3            | 1         | 1       | 1       | 1                  | 4                | 1              | 0.25               |
| 123519    | 1               | 1            | 0         | 3       | 1       | 0.3333333333333333 | 3                | 2              | 0.6666666666666666 |
| 123456    | 9               | 7            | 3         | 5       | 4       | 0.8                | 6                | 2              | 0.3333333333333333 |
| 123460    | 2               | 2            | 1         | 1       | 1       | 1                  | 2                | 2              | 1                  |
| 123517    | 8               | 5            | 3         | 3       | 2       | 0.6666666666666666 | 2                | 2              | 1                  |
| 123542    | 5               | 5            | 2         | 4       | 2       | 0.5                | 5                | 1              | 0.2                |
| 123482    | 0               | 0            | 0         | 2       | 1       | 0.5                | 2                | 1              | 0.5                |
| 123491    | 4               | 2            | 2         | 2       | 2       | 1                  | 5                | 1              | 0.2                |
| 123493    | 2               | 1            | 1         | 2       | 2       | 1                  | 2                | 0              | 0                  |
| 123511    | 7               | 6            | 3         | 2       | 1       | 0.5                | 2                | 2              | 1                  |
+-----------+-----------------+--------------+-----------+---------+---------+--------------------+------------------+----------------+--------------------+
Fetched 10 row(s) in 5.30s
```

