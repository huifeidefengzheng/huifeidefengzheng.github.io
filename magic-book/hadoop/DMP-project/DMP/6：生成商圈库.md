---
typora-root-url: image
---

[TOC]

## 2.14：生成商圈库

### 2.14.1：什么是商圈

商圈，是指商店以其所在地点为中心，沿着一定的方向和距离扩展，吸引顾客的辐射范围，简单地说，也就是来店顾客所居住的区域范围。无论大商场还是小商店，它们的销售总是有一定的地理范围。这个地理范围就是以商场为中心，向四周辐射至可能来店购买的消费者所居住的地点。 

![image-20181031131519323](image-20181031131519323.png)

因此，对于一个用户来说，我们会基于这个用户的IP，生成自己的商圈库；生成商圈库之后，我们会给每一个用户在建立标签阶段打上商圈标；

有了商圈标签，那么广告主在选择受众用户的时候，除了可以选择其他元素（性别，年龄，APP等），还可以选择所在的商圈范围，然后进行广告推广，进一步对的推动用户的消费意向 

### 2.14.2：APP类添加代码逻辑

```scala
//TODO 生成商圈库
BusinessAreaProcess.process(spark,context)
```

### 2.14.4：开发BusinessAreaProcess

注意:商圈库在kudu中存储，按照如下结构存储:

![image-20181101104905343](image-20181101104905343.png)

其中的geoHashCode作为主键，为了防止商圈库被覆盖的可能性，所以geoHashCode需要GeoHash对经纬度进行编码处理，保证值唯一



```scala
package pro

import java.util

import `trait`.Process
import bean.BusinessArea
import ch.hsr.geohash.GeoHash
import com.alibaba.fastjson.{JSON, JSONObject}
import org.apache.kudu.client.CreateTableOptions
import org.apache.kudu.spark.kudu.KuduContext
import org.apache.spark.sql.{Dataset, Row, SparkSession}
import utils.{ConfigUtils, DateUtils, HttpUtils, KuduUtils}
import scala.collection.JavaConverters._
import scala.util.Try

/**
  * 生成商圈库
  */
object BusinessAreaProcess extends Process{
  //定义原表
  val SOURCE_TABLE = s"ODS_${DateUtils.getNow()}"
  //定义kudu信息
  val options = Map[String,String](
    "kudu.master"->ConfigUtils.KUDU_MASTER,
    "kudu.table"->SOURCE_TABLE
  )
  //定义数据存入的表名
  val SINK_TABLE = s"business_area_${DateUtils.getNow()}"
  /**
    * 逻辑处理部分，后期不同的操作写不同的逻辑
    */
  override def process(spark: SparkSession, kuduContext: KuduContext): Unit = {

    //1、获取ODS表的数据
    import org.apache.kudu.spark.kudu._
    val odsDF = spark.read.options(options).kudu
    //过滤不符合要求的数据
    val tudeDF: Dataset[Row] = odsDF.filter("longitude is not null and latitude is not null")

    //2、取出经纬度，请求高德服务获取商圈
    //去重经纬度
    val distinctDF = tudeDF.selectExpr("latitude","longitude").distinct()
    val tudeRdd = distinctDF.rdd
    val areasRdd = tudeRdd.map(row => {
      //经度
      val longitude = row.getAs[Float]("longitude")
      //纬度
      val latitude = row.getAs[Float]("latitude")
      //拼接经纬度
      val longLat = s"${longitude},${latitude}"
      //获取服务URL
      val url = ConfigUtils.URL.format(longLat)
      //发起请求，获取数据
      val response: String = HttpUtils.get(url)
      //获取商圈列表,多个商圈以,分割
      val areas = parseJson(response)
      //将经纬度进行编码
      val genhash: String = GeoHash.geoHashStringWithCharacterPrecision(latitude.toDouble, longitude.toDouble, 8)

      (genhash, areas)
    })

    import spark.implicits._
    val areasDF = areasRdd.toDF("genhash","areas")

    //过滤出商圈列表为空的数据
    val result = areasDF.filter("areas!=''")
    //3、写入kudu
    //指定schema
    val schema = result.schema
    //指定表的属性 分区策略 分区数  分区字段
    val kuduoptions = new CreateTableOptions()
    //分区字段
    val columns = Seq[String]("genhash")

    kuduoptions.addHashPartitions(columns.asJava,3)

    //指定副本数
    kuduoptions.setNumReplicas(3)
    //指定主键
    val keys = columns
    KuduUtils.writeToKudu(kuduContext,schema,kuduoptions,SINK_TABLE,result,keys)
  }

  /**
    * scala 方式解析json
    * @param json
    * @return
    */
  def parseJson(json:String):String={

    import scala.collection.JavaConverters._
    Try(JSON.parseObject(json)
      .getJSONObject("regeocode")
      .getJSONObject("addressComponent")
      .getJSONArray("businessAreas")
      .toJavaList(classOf[BusinessArea])
      .asScala
      .map(_.name)
      .mkString(",")).getOrElse("")
  }

}

```

### 2.14.5：开发Inverse_geo

#### 2.14.5.1：基于经纬度进行商圈定位

1）：申请网址:

https://lbs.amap.com/

2）：登录或注册

![image-20181101105400631](image-20181101105400631.png)

3）：选择：开发支持---Web服务 API

![image-20181101105729898](image-20181101105729898.png)



4）：获取高德地图key---进入控制台—我的应用

![image-20181101110108755](image-20181101110108755.png)

5）：创建应用

![image-20181101110155958](image-20181101110155958.png)

6）：根据key进行逆地理编码

![image-20181101110415735](image-20181101110415735.png)

7）：服务示例：

https://restapi.amap.com/v3/geocode/regeo?output=xml&location=116.310003,39.991957&key=<用户的key>&radius=1000&extensions=all

（其中的location是由【经度,纬度】组成）

例如：

我的key是:6df5ca38579910c25a1816effec13e5f ， 那么我需要我需要拼接的https连接是：

https://restapi.amap.com/v3/geocode/regeo?output=xml&location=116.310003,39.991957&key=6df5ca38579910c25a1816effec13e5f&radius=1000&extensions=all

输入到浏览器中，可以返回如下XML信息：

![image-20181101111103502](image-20181101111103502.png)

8)：基于代码，进行http请求，获取返回的报文

```scala
package utils

import org.apache.commons.httpclient.HttpClient
import org.apache.commons.httpclient.methods.GetMethod

/**
  * http帮助类
  */
object HttpUtils {

  /**
    * 发起get请求
    * @return
    */
  def get(url:String):String = {

    val client = new HttpClient()

    val getMethod = new GetMethod(url)

    val code: Int = client.executeMethod(getMethod)

    if(code==200){
      getMethod.getResponseBodyAsString
    }else{
      ""
    }
  }
}

```



### 2.14.5：执行APP，并查询结果

#### 2.14.5.1：查看kudu页面，是否生成kudu表

![image-20181101113445068](image-20181101113445068.png)

#### 2.14.5.2：将kudu数据作为impala外部表，并查询数据是否进入kudu

```sql
CREATE EXTERNAL TABLE `TradingArea` STORED AS KUDU
TBLPROPERTIES(
    'kudu.table_name' = 'TradingArea',
    'kudu.master_addresses' = 'hadoop01:7051,hadoop02:7051,hadoop03:7051')
```

```sql
[angel1:21000] > select * from tradingarea limit 10;
Query: select * from tradingarea limit 10
Query submitted at: 2018-11-01 11:36:28 (Coordinator: http://angel1:25000)
Query progress can be monitored at: http://angel1:25000/query_plan?query_id=d4ae4f22d6d104e:2dd68d1700000000
+-------------+-------------------+
| geohashcode | businessarea      |
+-------------+-------------------+
| wkezhrkd    | 中华中路:文昌北路 |
| w7w6nchr    | 海甸:博爱         |
| wtemkb9k    | 安庆路:淮河路     |
| wwgqdmt7    | 鼓楼:大胡同       |
| wk3n3qjn    | 新村:北京路       |
| wm7b0ttr    | 大溪沟:上清寺     |
| wq3v1gg5    | 西园:兰工坪       |
| ws7gr02t    | 湖滨北路          |
| wwe0w76b    | 东门:长途汽车站   |
| wwymr5sp    | 中山路:东北路     |
+-------------+-------------------+
Fetched 10 row(s) in 0.43s
```

